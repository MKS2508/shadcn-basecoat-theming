<!-- Initialize core managers on client-side -->
<script>
  import { 
    ThemeManager, 
    ThemeInstaller, 
    ThemeListFetcher,
    getFontsByCategory
  } from '@mks2508/shadcn-basecoat-theme-manager';

  // Create global instances - ThemeManager includes its own ThemeRegistry and FontManager
  let themeManager = null;
  let themeInstaller = null;
  let themeListFetcher = null;

  async function initializeThemeCore() {
    try {
      console.log('ğŸ¨ Initializing Theme Core v3 (Fixed Architecture)...');

      // Initialize core managers - ThemeManager handles its own ThemeRegistry internally
      console.log('ğŸ“¦ Creating ThemeManager instance...');
      themeManager = new ThemeManager();
      console.log('âœ… ThemeManager created');

      console.log('ğŸ“¦ Creating ThemeInstaller instance...');
      themeInstaller = new ThemeInstaller(themeManager);
      console.log('âœ… ThemeInstaller created');

      console.log('ğŸ“¦ Creating ThemeListFetcher instance...');
      themeListFetcher = new ThemeListFetcher();
      console.log('âœ… ThemeListFetcher created');

      // Initialize all systems in correct order with individual error handling
      console.log('ğŸ”„ Initializing ThemeManager...');
      
      // Add timeout to detect if it hangs
      const themeManagerInitPromise = themeManager.init();
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('ThemeManager.init() timeout after 10 seconds')), 10000);
      });
      
      await Promise.race([themeManagerInitPromise, timeoutPromise]);
      console.log('âœ… ThemeManager initialized');


      console.log('ğŸ”„ Initializing ThemeInstaller...');
      await themeInstaller.init();
      console.log('âœ… ThemeInstaller initialized');

      console.log('ğŸ”„ Initializing ThemeListFetcher...');
      await themeListFetcher.init();
      console.log('âœ… ThemeListFetcher initialized');

      // Make instances globally available
      console.log('ğŸŒ Setting up window.themeCore...');
      window.themeCore = {
        themeManager,
        fontManager: themeManager.getFontManager(), // Use FontManager from ThemeManager
        themeInstaller,
        themeListFetcher,
        // Access ThemeRegistry through ThemeManager
        getThemeRegistry: () => themeManager.getThemeRegistry(),
        // Also expose the catalog function
        getFontsByCategory
      };
      console.log('âœ… window.themeCore created');

      console.log('ğŸ“Š Getting registry stats...');
      const stats = themeManager.getThemeRegistry().getStats();
      console.log('ğŸ“Š Registry stats:', stats);
      
      console.log('ğŸ” Getting available themes...');
      const availableThemes = themeManager.getAvailableThemes();
      console.log('ğŸ”§ Available themes:', availableThemes.length);
      
      console.log('ğŸ  Getting built-in themes...');
      const builtInThemes = themeManager.getThemeRegistry().getBuiltInThemes();
      console.log('ğŸ  Built-in themes:', builtInThemes.length);
      
      console.log('ğŸ“¦ Getting installed themes...');
      const installedThemes = themeManager.getThemeRegistry().getInstalledThemes();
      console.log('ğŸ“¦ Installed themes:', installedThemes.length);

      console.log('âœ… Theme Core initialized successfully');
      console.log('ğŸ”§ ThemeManager methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(themeManager)));
      
      // Dispatch event for other components
      console.log('ğŸš€ Dispatching theme-core-ready event...');
      console.log('ğŸ” About to dispatch with themeCore:', window.themeCore);
      
      const event = new CustomEvent('theme-core-ready', {
        detail: { themeCore: window.themeCore }
      });
      
      console.log('ğŸ“¤ Event created:', event);
      window.dispatchEvent(event);
      console.log('âœ… theme-core-ready event dispatched');

    } catch (error) {
      console.error('âŒ Failed to initialize Theme Core:', error);
      console.error('âŒ Error details:', error.message);
      console.error('âŒ Error stack:', error.stack);
      
      // Even if core fails, we should still provide basic functionality
      window.themeCore = null;
      window.dispatchEvent(new CustomEvent('theme-core-error', {
        detail: { error }
      }));
      
      // Also dispatch the ready event with null so components don't hang
      console.log('ğŸš¨ Dispatching theme-core-ready with null due to error');
      window.dispatchEvent(new CustomEvent('theme-core-ready', {
        detail: { themeCore: null, error: true }
      }));
    }
  }

  // Initialize immediately
  initializeThemeCore();
</script>